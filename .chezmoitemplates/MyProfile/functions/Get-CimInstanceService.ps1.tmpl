<#
.SYNOPSIS
Proxy helper function for Get-CimInstance Win32_Service

.DESCRIPTION
Proxy function to make accessing the Win32_Service class with Get-CimInstance easier. Be default, it filters out system-y type processes

.PARAMETER CimSession
See help on Get-CimInstance

.PARAMETER ClassName
See help on Get-CimInstance. Defaults to Win32_Service. Mandatory parameter attribute removed

.PARAMETER ResourceUri
See help on Get-CimInstance

.PARAMETER ComputerName
See help on Get-CimInstance

.PARAMETER KeyOnly
See help on Get-CimInstance

.PARAMETER Namespace
See help on Get-CimInstance

.PARAMETER OperationTimeoutSec
See help on Get-CimInstance

.PARAMETER InputObject
See help on Get-CimInstance

.PARAMETER Query
See help on Get-CimInstance

.PARAMETER QueryDialect
See help on Get-CimInstance

.PARAMETER Shallow
See help on Get-CimInstance

.PARAMETER Filter
See help on Get-CimInstance. Also by default usage of this will be incorporated in the default exclusion filter.
Handles generating a valid filter with parens and using AND.

.PARAMETER Property
See help on Get-CimInstance

.PARAMETER SkipFilter
New parameter for the proxy function. Allows falling back to standard usage of Get-CimInstance.
Won't pre-populate the Filter parameter.

.PARAMETER EscapeProxyFilterParameter
Impacts new parameters related to the filter like Name, Path, etc. Perform the single quote and backslash escaping. The backslash is the escape character in WQL.

.PARAMETER Name
Win32_Service.Name filter using LIKE. Required to escape characters by default. Consider EscapeProxyFilterParameter otherwise.

.PARAMETER PathName
Win32_Process.PathName filter using LIKE. Required to escape characters by default. Consider EscapeProxyFilterParameter otherwise.

.EXAMPLE
Get-CimInstanceService
Gets the local computers non system type processes

.NOTES
Had to mark the ClassName parameter as not mandatory so the help doesn't appear to be included. Marked the Filter parameter
with a validate parameter attribute.
#>
function Get-CimInstanceService {
    [Alias('gcims')]
    [CmdletBinding(DefaultParameterSetName = 'ClassNameComputerSet', HelpUri = 'https://go.microsoft.com/fwlink/?LinkId=227961')]
    param(
        [Parameter(ParameterSetName = 'CimInstanceSessionSet', Mandatory = $true, ValueFromPipeline = $true)]
        [Parameter(ParameterSetName = 'QuerySessionSet', Mandatory = $true, ValueFromPipeline = $true)]
        [Parameter(ParameterSetName = 'ClassNameSessionSet', Mandatory = $true, ValueFromPipeline = $true)]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet', Mandatory = $true, ValueFromPipeline = $true)]
        [CimSession[]]
        ${CimSession},

        [Parameter(ParameterSetName = 'ResourceUriSessionSet', Mandatory = $true, ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet', Mandatory = $true, ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'CimInstanceComputerSet')]
        [Parameter(ParameterSetName = 'CimInstanceSessionSet')]
        [Parameter(ParameterSetName = 'QueryComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'QuerySessionSet', ValueFromPipelineByPropertyName = $true)]
        [uri]
        ${ResourceUri},

        [Parameter(ParameterSetName = 'ClassNameComputerSet', Position = 0, ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet', Position = 0, ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'QueryComputerSet', Position = 0, ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'CimInstanceComputerSet', Position = 0)]
        [Alias('CN', 'ServerName')]
        [string[]]
        ${ComputerName},

        [Parameter(ParameterSetName = 'ClassNameComputerSet')]
        [Parameter(ParameterSetName = 'ClassNameSessionSet')]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet')]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet')]
        [switch]
        ${KeyOnly},

        [Parameter(ParameterSetName = 'ClassNameComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ClassNameSessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'QueryComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'QuerySessionSet', ValueFromPipelineByPropertyName = $true)]
        [string]
        ${Namespace},

        [Alias('OT')]
        [uint]
        ${OperationTimeoutSec},

        [Parameter(ParameterSetName = 'CimInstanceComputerSet', Mandatory = $true, ValueFromPipeline = $true)]
        [Parameter(ParameterSetName = 'CimInstanceSessionSet', Mandatory = $true, ValueFromPipeline = $true)]
        [Alias('CimInstance')]
        [ciminstance]
        ${InputObject},

        [Parameter(ParameterSetName = 'QueryComputerSet', Mandatory = $true, ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'QuerySessionSet', Mandatory = $true, ValueFromPipelineByPropertyName = $true)]
        [string]
        ${Query},

        [Parameter(ParameterSetName = 'QueryComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'QuerySessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ClassNameSessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ClassNameComputerSet', ValueFromPipelineByPropertyName = $true)]
        [string]
        ${QueryDialect},

        [Parameter(ParameterSetName = 'ClassNameComputerSet')]
        [Parameter(ParameterSetName = 'ClassNameSessionSet')]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet')]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet')]
        [Parameter(ParameterSetName = 'QueryComputerSet')]
        [Parameter(ParameterSetName = 'QuerySessionSet')]
        [switch]
        ${Shallow},

        [Parameter(ParameterSetName = 'ClassNameSessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ClassNameComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet', ValueFromPipelineByPropertyName = $true)]
{{ if eq .isPSCore true }}        [ValidateNotNullOrWhiteSpace()]{{ else }}        [ValidateNotNullOrEmpty()]{{ end }}
        [string]
        ${Filter},

        [Parameter(ParameterSetName = 'ClassNameSessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ClassNameComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet', ValueFromPipelineByPropertyName = $true)]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet', ValueFromPipelineByPropertyName = $true)]
        [Alias('SelectProperties')]
        [string[]]
        ${Property},

        [Parameter(ParameterSetName = 'ClassNameSessionSet')]
        [Parameter(ParameterSetName = 'ClassNameComputerSet')]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet')]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet')]
        [Alias('sf', 'All')]
        [switch]
        ${SkipFilter},

        [Parameter(ParameterSetName = 'ClassNameSessionSet')]
        [Parameter(ParameterSetName = 'ClassNameComputerSet')]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet')]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet')]
        [Alias('EscapeCharacters', 'ec', 'epfp')]
        [switch]
        ${EscapeProxyFilterParameter},

        [Parameter(ParameterSetName = 'ClassNameSessionSet')]
        [Parameter(ParameterSetName = 'ClassNameComputerSet')]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet')]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet')]
        [Alias('nm')]
        [string]
        ${Name},

        [Parameter(ParameterSetName = 'ClassNameSessionSet')]
        [Parameter(ParameterSetName = 'ClassNameComputerSet')]
        [Parameter(ParameterSetName = 'ResourceUriSessionSet')]
        [Parameter(ParameterSetName = 'ResourceUriComputerSet')]
        [Alias('pt', 'pn')]
        [string]
        ${PathName}
    )

    begin {
        try {
            $outBuffer = $null
            if ($PSBoundParameters.TryGetValue('OutBuffer', [ref]$outBuffer)) {
                $PSBoundParameters['OutBuffer'] = 1
            }

            if (-not $SkipFilter) {
                $customExcludeFilter = @(
                    "NOT PathName LIKE '%zohomeeting%'"
                    "NOT PathName LIKE '%windows%media%player%'"
                    "NOT PathName LIKE '%trustedinstaller%'"
                    "NOT PathName LIKE '%microsoft.net%'"
                    "NOT PathName LIKE '%google\\chrome%'"
                    "NOT PathName LIKE '%google%google%'"
                    "NOT PathName LIKE '%microsoft%edge%'"
                    "NOT PathName LIKE '%veeam%'"
                    "NOT PathName LIKE '%windows%defend%'"
                    "NOT PathName LIKE '%vmware%tool%'"
                    "NOT PathName LIKE '%sysmon64%'"
                    "NOT PathName LIKE '%syswow64%'"
                    "NOT PathName LIKE '%system32%'"
                    "NOT PathName LIKE '%SentinelOne%'"
                    "NOT PathName LIKE '%Arctic Wolf%'"
                    "NOT PathName LIKE '%Common Files\\Microsoft Shared%'"
                    "NOT PathName LIKE '%ManageEngine\\UEMS_Agent%'"
                    "NOT PathName LIKE '%Tanium\\Tanium Client%'"
                ) -join ' AND '
                if ($PSBoundParameters.ContainsKey('Filter')) {
                    $customExcludeFilter = " AND ( $customExcludeFilter )"
                }
                else {
                    $customExcludeFilter = "( $customExcludeFilter )"
                }
                $PSBoundParameters['Filter'] += $customExcludeFilter
            }
            if ($Name) {
                $PSBoundParameters['Filter'] += " AND Name LIKE '$($Name | Invoke-EscapeProxyFilterParameter -Escape:$EscapeProxyFilterParameter)'"
            }
            if ($PathName) {
                $PSBoundParameters['Filter'] += " AND PathName LIKE '$($PathName | Invoke-EscapeProxyFilterParameter -Escape:$EscapeProxyFilterParameter)'"
            }
            # SkipFilter doesn't exist on proxied command
            $PSBoundParameters.Remove('SkipFilter') | Out-Null # Returns true or false if found and not found
            $PSBoundParameters.Remove('EscapeProxyFilterParameter') | Out-Null
            $PSBoundParameters.Remove('Name') | Out-Null
            $PSBoundParameters.Remove('PathName') | Out-Null
            $PSBoundParameters['ClassName'] = 'Win32_Service'

            $wrappedCmd = $ExecutionContext.InvokeCommand.GetCommand('CimCmdlets\Get-CimInstance', [System.Management.Automation.CommandTypes]::Cmdlet)
            $scriptCmd = {
                & $wrappedCmd @PSBoundParameters | & {
                    process {
                        if ( $_.psobject.Properties.Name -contains 'PSShowComputerName') {
                            $_.PSShowComputerName = $false
                        }
                        $_.PSTypeNames.Insert( 0, 'MacMicrosoft.Management.Infrastructure.CimInstance#root/cimv2/Win32_Service' )
                        $_
                    }
                }
            }
            $steppablePipeline = $scriptCmd.GetSteppablePipeline($MyInvocation.CommandOrigin)
            $steppablePipeline.Begin($PSCmdlet)
        }
        catch {
            throw
        }
    }

    process {
        try {
            $steppablePipeline.Process($_)
        }
        catch {
            throw
        }
    }

    end {
        try {
            $steppablePipeline.End()
        }
        catch {
            throw
        }
    }
{{ if eq .isPSCore true }}
    clean {
        if ($null -ne $steppablePipeline) {
            $steppablePipeline.Clean()
        }
    }
{{ end }}
# Cannot forward help because the parameter set is a bit different
}
